<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${hecho.titulo} ?: ' - Editar Hecho'">MetaMapa - Editar Hecho</title>

    <link rel="stylesheet" th:href="@{/css/global.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/hecho.css}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        /* Estilo para botón deshabilitado (Sin cambios) */
        button:disabled {
            background-color: #cbd5e1 !important; /* Gris claro */
            color: #64748b !important;
            cursor: not-allowed;
            border-color: #cbd5e1 !important;
            transform: none !important; /* Evita efecto click */
        }
    </style>
</head>

<body>
<div th:replace="fragments/header :: header"></div>

<div class="detail-container">

    <div class="stat-card">

        <form th:object="${hecho}"
              th:action="@{/hechos/{id}/editar(id=${id})}"
              method="post" enctype="multipart/form-data">

            <input type="hidden" th:field="*{estado}">
            <input type="hidden" th:field="*{usuario}">

            <div style="margin-bottom: 20px;">
                <h1 class="section-title">Editar Hecho</h1>
            </div>

            <div th:if="${globalError}" class="api-error-alert">
                <strong th:text="${globalError}"></strong>
                <ul th:if="${errorDetails}" class="error-list">
                    <li th:each="det : ${errorDetails}" th:text="${det}"></li>
                </ul>
            </div>

            <div class="content-block">
                <label class="content-title">Imágenes</label>

                <div class="gallery-container editable-gallery" id="main-gallery"
                     th:style="${#lists.isEmpty(hecho.multimedia)} ? 'display: none;' : ''">

                    <div th:if="${not #lists.isEmpty(hecho.multimedia)}"
                         th:each="img, stat : *{multimedia}"
                         class="gallery-item-wrapper existing-item"
                         th:id="'img-wrapper-' + ${stat.index}">

                        <div class="gallery-item">
                            <img th:src="@{'/hechos/uploads/' + ${img}}" alt="Existente">
                        </div>

                        <button type="button" class="btn-delete-img"
                                th:onclick="'removeExistingImage(' + ${stat.index} + ')'"
                                title="Eliminar">×</button>

                        <input type="hidden" th:field="*{multimedia[__${stat.index}__]}" th:id="'input-img-' + ${stat.index}">
                    </div>

                    <div id="preview-container" style="display: contents;"></div>

                </div>

                <div style="margin-top: 15px;">
                    <input type="file" id="file-input" name="nuevasImagenes" multiple accept="image/*"
                           onchange="handleFileSelect()">

                    <button type="button" class="btn btn--secondary" onclick="document.getElementById('file-input').click()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                        Seleccionar fotos nuevas
                    </button>
                    <span id="file-count" style="margin-left: 10px; color: #666; font-size: 0.9rem;"></span>
                </div>
            </div>

            <div class="content-block">
                <label class="content-title" for="titulo">Título</label>
                <input id="titulo" class="clean-input" type="text" th:field="*{titulo}"
                       th:classappend="${errores != null and errores.containsKey('titulo')} ? 'input-error' : ''"
                       placeholder="Título...">
                <span class="field-error-msg" th:if="${errores != null and errores.containsKey('titulo')}" th:text="${errores['titulo']}"></span>
            </div>

            <div class="content-block">
                <label class="content-title" for="descripcion">Descripción</label>
                <textarea id="descripcion" class="clean-input" th:field="*{descripcion}" rows="6"
                          th:classappend="${errores != null and errores.containsKey('descripcion')} ? 'input-error' : ''"
                          placeholder="Descripción...">
                </textarea>
                <span class="field-error-msg" th:if="${errores != null and errores.containsKey('descripcion')}" th:text="${errores['descripcion']}"></span>
            </div>

            <div class="content-block">
                <label class="content-title" for="categoria">Categoría</label>

                <div class="autocomplete-wrapper" id="categoria-wrapper">
                    <input id="categoria"
                           class="clean-input"
                           type="text"
                           th:field="*{categoria}"
                           placeholder="Escribe o selecciona..."
                           autocomplete="off"
                           oninput="filterCategories(); checkChanges();"
                           onfocus="showCategories()"
                           th:classappend="${errores != null and errores.containsKey('categoria')} ? 'input-error' : ''">

                    <ul id="categoria-list" class="autocomplete-list">
                        <li th:each="cat : ${categorias}"
                            class="autocomplete-item"
                            th:text="${cat.nombre}"
                            th:data-valor="${cat.nombre}"
                            onclick="selectCategory(this.getAttribute('data-valor'))">
                        </li>
                        <li id="no-results"
                            class="autocomplete-item"
                            style="display:none; color: #2b6cb0; font-weight: 600;"
                            onclick="selectCategory(document.getElementById('categoria').value)">
                            Presiona Enter para crear nueva
                        </li>
                    </ul>
                </div>

                <span class="field-error-msg" th:if="${errores != null and errores.containsKey('categoria')}" th:text="${errores['categoria']}"></span>
                <div th:if="${warningCategorias}" class="input-warning-msg">
                    <span th:text="${warningCategorias}"></span>
                </div>
            </div>

            <div class="content-block">
                <label class="content-title" for="fecha">Fecha del hecho</label>
                <input id="fecha" class="clean-input" type="datetime-local" name="fecha"
                       th:value="${#temporals.format(hecho.fecha, 'yyyy-MM-dd''T''HH:mm')}"
                       th:classappend="${errores != null and errores.containsKey('fecha')} ? 'input-error' : ''">
                <span class="field-error-msg" th:if="${errores != null and errores.containsKey('fecha')}" th:text="${errores['fecha']}"></span>
            </div>

            <div class="content-block" style="border-bottom: none;">
                <label class="content-title" for="address-input">Ubicación (Click en el mapa para corregir automáticamente)</label>

                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="address-input" class="clean-input" placeholder="Buscar dirección...">
                    <button type="button" class="btn btn--secondary" id="geocode-btn">Buscar</button>
                </div>

                <div id="map-editable" style="height: 400px; border-radius: 8px;"></div>

                <input type="hidden" id="lat-input" th:field="*{latitud}">
                <input type="hidden" id="lng-input" th:field="*{longitud}">

                <div th:if="${errores != null}">
                    <span class="field-error-msg" th:if="${errores.containsKey('latitud')}" th:text="${errores['latitud']}"></span>
                    <span class="field-error-msg" th:if="${errores.containsKey('longitud')}" th:text="${errores['longitud']}"></span>
                </div>
            </div>

            <div class="form-actions">
                <button id="btn-submit" class="btn btn--primary" type="submit" disabled>Sin cambios</button>
                <a th:href="@{/hechos/{id}/detalle(id=${id})}" class="btn btn--third">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script th:inline="javascript">
    // Variable global para acumular archivos
    let dt = new DataTransfer();

    // Variable para guardar el estado inicial
    let initialState = {};

    // Función global de checkeo (la llamamos desde varios puntos)
    function checkChanges() {
        const submitBtn = document.getElementById('btn-submit');
        if (!submitBtn) return;

        // 1. Estado actual
        const currentState = {
            titulo: document.getElementById('titulo').value,
            descripcion: document.getElementById('descripcion').value,
            categoria: document.getElementById('categoria').value,
            fecha: document.getElementById('fecha').value,
            lat: document.getElementById('lat-input').value,
            lng: document.getElementById('lng-input').value,
            existingImages: document.querySelectorAll('.existing-item').length
        };

        // 2. Comparaciones
        const fieldsChanged = JSON.stringify(initialState) !== JSON.stringify(currentState);
        const hasNewFiles = dt.files.length > 0;
        const hasDeletedFiles = currentState.existingImages < initialState.existingImages;

        // 3. Activar / Desactivar
        if (fieldsChanged || hasNewFiles || hasDeletedFiles) {
            submitBtn.disabled = false;
            submitBtn.innerText = "Guardar Cambios";
        } else {
            submitBtn.disabled = true;
            submitBtn.innerText = "Sin cambios";
        }
    }

    function handleFileSelect() {
        const fileInput = document.getElementById('file-input');
        const newFiles = fileInput.files;

        for (let i = 0; i < newFiles.length; i++) {
            if (newFiles[i].type.startsWith('image/')) {
                let exists = false;
                for(let j=0; j<dt.files.length; j++){
                    if(dt.files[j].name === newFiles[i].name && dt.files[j].size === newFiles[i].size){
                        exists = true; break;
                    }
                }
                if(!exists) dt.items.add(newFiles[i]);
            }
        }

        fileInput.files = dt.files;
        renderNewPreviews();
        updateGalleryVisibility();
        checkChanges(); // <-- Check
    }

    function renderNewPreviews() {
        const previewContainer = document.getElementById('preview-container');
        const fileCount = document.getElementById('file-count');
        previewContainer.innerHTML = '';

        if (dt.files.length > 0) {
            fileCount.textContent = `${dt.files.length} imagen(es) nueva(s)`;
        } else {
            fileCount.textContent = '';
        }

        Array.from(dt.files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const wrapper = document.createElement('div');
                wrapper.className = 'gallery-item-wrapper';
                wrapper.innerHTML = `
                <div class="gallery-item gallery-item-new">
                    <img src="${e.target.result}" alt="Nueva">
                </div>
                <span class="badge-new">NUEVA</span>
                <button type="button" class="btn-delete-img"
                        onclick="removeNewFile(${index})" title="Quitar">×</button>
            `;
                previewContainer.appendChild(wrapper);
            };
            reader.readAsDataURL(file);
        });
    }

    function removeNewFile(index) {
        const fileInput = document.getElementById('file-input');
        const newDt = new DataTransfer();
        Array.from(dt.files).forEach((file, i) => {
            if (i !== index) newDt.items.add(file);
        });
        dt = newDt;
        fileInput.files = dt.files;
        renderNewPreviews();
        updateGalleryVisibility();
        checkChanges(); // <-- Check
    }

    function removeExistingImage(index) {
        const wrapper = document.getElementById('img-wrapper-' + index);
        if(wrapper) {
            wrapper.remove();
            const inputHidden = document.getElementById('input-img-' + index);
            if(inputHidden) inputHidden.remove();
            updateGalleryVisibility();
            checkChanges(); // <-- Check
        }
    }

    function updateGalleryVisibility() {
        const gallery = document.getElementById('main-gallery');
        const existingItems = document.querySelectorAll('.existing-item');
        const newItemsCount = dt.files.length;

        if (existingItems.length === 0 && newItemsCount === 0) {
            gallery.style.display = 'none';
        } else {
            gallery.style.display = 'flex';
        }
    }

    // --- DOM READY ---
    document.addEventListener('DOMContentLoaded', function() {
        // 1. CAPTURAR ESTADO INICIAL
        initialState = {
            titulo: document.getElementById('titulo').value,
            descripcion: document.getElementById('descripcion').value,
            categoria: document.getElementById('categoria').value,
            fecha: document.getElementById('fecha').value,
            lat: document.getElementById('lat-input').value,
            lng: document.getElementById('lng-input').value,
            existingImages: document.querySelectorAll('.existing-item').length
        };

        // 2. LISTENERS PARA INPUTS DE TEXTO
        ['titulo', 'descripcion', 'fecha', 'address-input'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('input', checkChanges);
        });

        /* Configuración Mapa */
        const latInicial = /*[[${hecho.latitud ?: -34.6037}]]*/ -34.6037;
        const lngInicial = /*[[${hecho.longitud ?: -58.3816}]]*/ -58.3816;

        const mapElement = document.getElementById('map-editable');
        const latInput = document.getElementById('lat-input');
        const lngInput = document.getElementById('lng-input');
        const addressInput = document.getElementById('address-input');
        const geocodeBtn = document.getElementById('geocode-btn');

        if (mapElement) {
            const map = L.map('map-editable').setView([latInicial, lngInicial], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
            let marker = L.marker([latInicial, lngInicial]).addTo(map);

            function updateMapAndInputs(lat, lng) {
                if (marker) map.removeLayer(marker);
                marker = L.marker([lat, lng]).addTo(map);
                latInput.value = lat;
                lngInput.value = lng;
                checkChanges(); // <-- Check cambio mapa
            }

            map.on('click', (e) => {
                const { lat, lng } = e.latlng;
                updateMapAndInputs(lat, lng);

                addressInput.value = "Buscando dirección exacta...";
                addressInput.disabled = true;

                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
                fetch(url)
                    .then(r => r.json())
                    .then(data => {
                        addressInput.value = (data && data.display_name) ? data.display_name : "Ubicación seleccionada";
                        checkChanges(); // Check por si cambia el texto del input
                    })
                    .catch(() => addressInput.value = "Error al obtener calle")
                    .finally(() => addressInput.disabled = false);
            });

            if(geocodeBtn) {
                geocodeBtn.addEventListener('click', () => {
                    const address = addressInput.value.trim();
                    if (!address) { alert("Ingresá una dirección."); return; }

                    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`;
                    fetch(url).then(r => r.json()).then(data => {
                        if (data && data.length > 0) {
                            const { lat, lon } = data[0];
                            updateMapAndInputs(parseFloat(lat), parseFloat(lon));
                            map.setView([lat, lon], 16);
                        } else { alert("No se encontraron resultados."); }
                    }).catch(() => alert("Error buscando dirección."));
                });
            }
        }
    });

    // --- CATEGORIAS ---
    const inputCat = document.getElementById('categoria');
    const listCat = document.getElementById('categoria-list');
    const allItems = listCat ? listCat.getElementsByClassName('autocomplete-item') : [];
    let currentFocus = -1;

    inputCat.addEventListener("keydown", function(e) {
        if (!listCat.classList.contains('active')) return;
        let visibleItems = getVisibleItems();
        if (e.key === "ArrowDown") {
            currentFocus++;
            addActive(visibleItems);
        } else if (e.key === "ArrowUp") {
            currentFocus--;
            addActive(visibleItems);
        } else if (e.key === "Enter") {
            if (currentFocus > -1) {
                e.preventDefault();
                if (visibleItems[currentFocus]) visibleItems[currentFocus].click();
            }
        } else if (e.key === "Escape") {
            closeList();
        }
    });

    function getVisibleItems() {
        let visibles = [];
        for (let i = 0; i < allItems.length; i++) {
            if (allItems[i].style.display !== "none") visibles.push(allItems[i]);
        }
        return visibles;
    }

    function addActive(x) {
        if (!x || x.length === 0) return false;
        if (currentFocus >= x.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (x.length - 1);
        removeActive(x);
        x[currentFocus].classList.add("autocomplete-active");
        x[currentFocus].scrollIntoView({ block: 'nearest', inline: 'start' });
    }

    function removeActive(x) {
        for (let i = 0; i < x.length; i++) {
            x[i].classList.remove("autocomplete-active");
        }
    }

    function showCategories() {
        if(!listCat) return;
        filterCategories();
        listCat.classList.add('active');
        inputCat.classList.add('dropdown-open');
    }

    function filterCategories() {
        if(!listCat) return;
        const filter = inputCat.value.toLowerCase();
        let visibleCount = 0;
        currentFocus = -1;
        removeActive(allItems);

        for (let i = 0; i < allItems.length; i++) {
            const item = allItems[i];
            if (item.id === 'no-results') continue;
            const txtValue = item.textContent || item.innerText;
            if (txtValue.toLowerCase().indexOf(filter) > -1) {
                item.style.display = "";
                visibleCount++;
            } else {
                item.style.display = "none";
            }
        }

        const noResults = document.getElementById('no-results');
        if (visibleCount === 0 && filter !== '') {
            if(noResults) {
                noResults.style.display = "block";
                noResults.innerText = `Crear nueva: "${inputCat.value}"`;
            }
        } else {
            if(noResults) noResults.style.display = "none";
        }
        listCat.classList.add('active');
    }

    function selectCategory(valor) {
        inputCat.value = valor;
        closeList();
        checkChanges(); // <-- Check cambio categoria
    }

    function closeList() {
        if(listCat) {
            listCat.classList.remove('active');
            inputCat.classList.remove('dropdown-open');
            currentFocus = -1;
        }
    }

    document.addEventListener('click', function(e) {
        const wrapper = document.getElementById('categoria-wrapper');
        if (wrapper && !wrapper.contains(e.target)) {
            closeList();
        }
    });
</script>

</body>
</html>