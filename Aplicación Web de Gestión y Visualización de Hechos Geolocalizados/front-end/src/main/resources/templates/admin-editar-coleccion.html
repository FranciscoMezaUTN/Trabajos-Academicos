<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editar Colección - MetaMapa Admin</title>

    <link rel="stylesheet" th:href="@{/css/global.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/hecho.css}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
<div class="admin-layout">
    <aside class="sidebar">
        <a th:href="@{/}" class="logo">MetaMapa Admin</a>
        <nav class="sidebar__nav">
            <a th:href="@{/admin/dashboard}" class="sidebar__link">Dashboard</a>
            <a th:href="@{/admin/colecciones}" class="sidebar__link sidebar__link--active">Colecciones</a>
            <a th:href="@{/admin/revisiones}" class="sidebar__link">Revisiones</a>
        </nav>
        <a th:href="@{/auth/logout}" class="btn btn--secondary sidebar__logout">Cerrar Sesión</a>
    </aside>

    <div class="main-content">
        <div class="detail-container">
            <h1 class="page-title">Gestión de Colecciones</h1>
            <div class="stat-card">

                <form id="main-form"
                      th:action="@{/admin/colecciones/{id}/editar(id=${idColeccion})}"
                      th:object="${coleccion}"
                      method="post">

                    <div style="margin-bottom: 30px;">
                        <h1 class="section-title">Editar Colección</h1>
                    </div>

                    <div th:if="${globalError}" class="api-error-alert mb-2">
                        <strong th:text="${globalError}"></strong>
                    </div>

                    <div th:if="${#fields.hasGlobalErrors()}" class="api-error-alert mb-2">
                        <p th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
                    </div>

                    <div class="content-block">
                        <label class="content-title" for="titulo">Título</label>
                        <input type="text" id="titulo" th:field="*{titulo}"
                               class="clean-input"
                               th:classappend="${#fields.hasErrors('titulo')} ? 'input-error' : ''"
                               placeholder="Ej: Eventos Naturales de Argentina">
                        <span class="field-error-msg" th:if="${#fields.hasErrors('titulo')}" th:errors="*{titulo}"></span>
                    </div>

                    <div class="content-block">
                        <label class="content-title" for="descripcion">Descripción</label>
                        <textarea id="descripcion" th:field="*{descripcion}"
                                  class="clean-input" rows="4"
                                  th:classappend="${#fields.hasErrors('descripcion')} ? 'input-error' : ''"
                                  placeholder="Breve descripción de la colección"></textarea>
                        <span class="field-error-msg" th:if="${#fields.hasErrors('descripcion')}" th:errors="*{descripcion}"></span>
                    </div>

                    <div class="content-block">
                        <label class="content-title">Fuentes Asociadas</label>

                        <div th:if="${#lists.isEmpty(fuentesDisponibles)}" class="input-warning-msg">
                            No hay fuentes disponibles.
                        </div>

                        <div th:unless="${#lists.isEmpty(fuentesDisponibles)}" class="checkbox-list">

                            <div th:each="fuente : ${fuentesDisponibles}" class="checkbox-card">

                                <input type="checkbox"
                                       th:field="*{fuentesIds}"
                                       th:value="${fuente.id}"
                                       th:id="${'fuente-' + fuente.id}">

                                <label th:for="${'fuente-' + fuente.id}"
                                       th:text="${fuente.nombre}">
                                </label>
                            </div>

                        </div>

                        <span class="field-error-msg" th:if="${#fields.hasErrors('fuentesIds')}" th:errors="*{fuentesIds}"></span>
                    </div>

                    <div class="content-block">
                        <label class="content-title" for="algoritmoConsenso">Algoritmo de Consenso</label>
                        <select id="algoritmoConsenso" th:field="*{algoritmoConsenso}" class="clean-input" style="background-color: white;">
                            <option value="">Seleccioná un algoritmo (opcional)</option>
                            <option th:value="MULTIPLES_MENCIONES">Múltiples menciones</option>
                            <option th:value="MAYORIA_SIMPLE">Mayoría simple</option>
                            <option th:value="ABSOLUTA">Absoluta</option>
                        </select>
                    </div>

                    <div class="content-block" style="border-bottom: none; padding-bottom: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <label class="content-title" style="margin-bottom: 0;">Criterios de Pertenencia</label>
                            <button type="button" class="btn btn--small btn--secondary" onclick="agregarCriterio()">Agregar Criterio</button>
                        </div>

                        <div id="criterios-container">
                            <div th:each="criterio, stat : *{criteriosDePertenencias}"
                                 class="criterio-card"
                                 th:id="|criterio-row-${stat.index}|">

                                <input type="hidden"
                                       th:field="*{criteriosDePertenencias[__${stat.index}__].id}">

                                <button type="button" class="btn-delete-absolute" th:attr="onclick=|eliminarCriterio(${stat.index})|" title="Eliminar">&times;</button>

                                <div class="form-grid-2">
                                    <div>
                                        <label class="content-title" style="font-size: 0.8rem;">Nombre del Criterio</label>
                                        <input type="text"
                                               th:field="*{criteriosDePertenencias[__${stat.index}__].nombreCriterio}"
                                               class="clean-input"
                                               th:classappend="${#fields.hasErrors('criteriosDePertenencias[__${stat.index}__].nombreCriterio')} ? 'input-error' : ''">
                                        <span class="field-error-msg" th:if="${#fields.hasErrors('criteriosDePertenencias[__${stat.index}__].nombreCriterio')}" th:errors="*{criteriosDePertenencias[__${stat.index}__].nombreCriterio}"></span>
                                    </div>
                                    <div>
                                        <label class="content-title" style="font-size: 0.8rem;">Tipo de Criterio</label>
                                        <select th:field="*{criteriosDePertenencias[__${stat.index}__].tipoCriterio}"
                                                class="clean-input"
                                                th:id="|select-tipo-${stat.index}|"
                                                th:attr="onchange=|actualizarParametros(this, ${stat.index})|"
                                                th:classappend="${#fields.hasErrors('criteriosDePertenencias[__${stat.index}__].tipoCriterio')} ? 'input-error' : ''">
                                            <option value="">Seleccionar tipo...</option>
                                            <option value="FECHA">Rango de Fechas</option>
                                            <option value="CATEGORIA">Categoría Específica</option>
                                        </select>
                                        <span class="field-error-msg" th:if="${#fields.hasErrors('criteriosDePertenencias[__${stat.index}__].tipoCriterio')}" th:errors="*{criteriosDePertenencias[__${stat.index}__].tipoCriterio}"></span>
                                    </div>
                                </div>

                                <div th:id="|parametros-${stat.index}|">
                                    <th:block th:if="${#strings.toString(criterio.tipoCriterio) == 'FECHA'}">
                                        <div class="form-grid-2">
                                            <div>
                                                <label class="content-title" style="font-size: 0.8rem;">Desde</label>
                                                <input type="date"
                                                       th:field="*{criteriosDePertenencias[__${stat.index}__].parametros['fechaInicio']}"
                                                       class="clean-input"
                                                       th:classappend="${#fields.hasErrors('criteriosDePertenencias[__${stat.index}__].parametros[fechaInicio]')} ? 'input-error' : ''">
                                                <span class="field-error-msg" th:if="${#fields.hasErrors('criteriosDePertenencias[__${stat.index}__].parametros[fechaInicio]')}" th:errors="*{criteriosDePertenencias[__${stat.index}__].parametros[fechaInicio]}"></span>
                                            </div>
                                            <div>
                                                <label class="content-title" style="font-size: 0.8rem;">Hasta</label>
                                                <input type="date"
                                                       th:field="*{criteriosDePertenencias[__${stat.index}__].parametros['fechaFin']}"
                                                       class="clean-input"
                                                       th:classappend="${#fields.hasErrors('criteriosDePertenencias[__${stat.index}__].parametros[fechaFin]')} ? 'input-error' : ''">
                                                <span class="field-error-msg" th:if="${#fields.hasErrors('criteriosDePertenencias[__${stat.index}__].parametros[fechaFin]')}" th:errors="*{criteriosDePertenencias[__${stat.index}__].parametros[fechaFin]}"></span>
                                            </div>
                                        </div>
                                    </th:block>

                                    <th:block th:if="${#strings.toString(criterio.tipoCriterio) == 'CATEGORIA'}">
                                        <label class="content-title" style="font-size: 0.8rem;">Categoría Requerida</label>
                                        <div class="autocomplete-wrapper" th:id="|cat-wrapper-${stat.index}|">
                                            <input type="text"
                                                   th:id="|cat-input-${stat.index}|"
                                                   th:field="*{criteriosDePertenencias[__${stat.index}__].parametros['categoria']}"
                                                   class="clean-input"
                                                   placeholder="Escribe o selecciona..."
                                                   autocomplete="off"
                                                   th:attr="oninput=|filterDynamicCat(${stat.index}); checkChanges();|, onfocus=|showDynamicCat(${stat.index})|, onkeydown=|handleKeydown(${stat.index}, event)|"
                                                   th:classappend="${#fields.hasErrors('criteriosDePertenencias[__${stat.index}__].parametros[categoria]')} ? 'input-error' : ''">

                                            <ul th:id="|cat-list-${stat.index}|" class="autocomplete-list">
                                                <li th:each="cat : ${categoriasDisponibles}"
                                                    class="autocomplete-item"
                                                    th:text="${cat.nombre}"
                                                    th:attr="onclick=|selectDynamicCat(${stat.index}, '${cat.nombre}')|">
                                                </li>
                                                <li th:id="|no-results-${stat.index}|"
                                                    class="autocomplete-item autocomplete-create-item"
                                                    th:attr="onclick=|selectDynamicCat(${stat.index}, document.getElementById('cat-input-${stat.index}').value)|">
                                                </li>
                                            </ul>
                                        </div>
                                        <span class="field-error-msg" th:if="${#fields.hasErrors('criteriosDePertenencias[__${stat.index}__].parametros[categoria]')}" th:errors="*{criteriosDePertenencias[__${stat.index}__].parametros[categoria]}"></span>
                                    </th:block>
                                </div>
                            </div>
                        </div>

                        <span class="field-error-msg"
                              th:if="${#fields.hasErrors('criteriosDePertenencias')}"
                              th:errors="*{criteriosDePertenencias}">
                        </span>
                    </div>

                    <div class="form-actions">
                        <button id="btn-submit" type="submit" class="btn btn--primary" disabled>Sin cambios</button>
                        <a th:href="@{/admin/colecciones/{id}/detalle(id=${idColeccion})}" class="btn btn--third">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">

    /*[[${categoriasDisponibles}]]*/
    const categoriasBackend = [[${categoriasDisponibles}]] || [];
    let criterioIndex = [[${coleccion.criteriosDePertenencias != null ? coleccion.criteriosDePertenencias.size() : 0}]];

    let focusStates = {};
    let initialState = null;

    // --- NUEVA FUNCIÓN MÁGICA: REORDENAR ÍNDICES ---
    // Esto asegura que si borras el índice 0, el 1 pase a ser 0.
    // Así Spring nunca recibe "huecos" (List gaps) y no valida objetos vacíos.
    function reordenarIndices() {
        const tarjetas = document.querySelectorAll('.criterio-card');
        tarjetas.forEach((card, nuevoIndex) => {
            // Buscamos todos los inputs, selects y textareas dentro de esta tarjeta
            const inputs = card.querySelectorAll('input, select, textarea');

            inputs.forEach(input => {
                // Reemplazamos cualquier cosa que parezca [123] por [nuevoIndex]
                // Ej: criteriosDePertenencias[5].nombre -> criteriosDePertenencias[0].nombre
                if (input.name) {
                    input.name = input.name.replace(/\[\d+\]/, `[${nuevoIndex}]`);
                }
            });
        });
    }

    function getFormState() {
        const state = {
            titulo: document.getElementById('titulo').value,
            descripcion: document.getElementById('descripcion').value,
            algoritmo: document.getElementById('algoritmoConsenso').value,
            fuentes: Array.from(document.querySelectorAll('.chk-fuente:checked')).map(c => c.value).sort(),
            criterios: []
        };
        document.querySelectorAll('.criterio-card').forEach((card, idx) => {
            const nombreInput = card.querySelector('input[name*="nombreCriterio"]');
            const tipoSelect = card.querySelector('select[name*="tipoCriterio"]');
            const fechaInicio = card.querySelector('input[name*="fechaInicio"]');
            const fechaFin = card.querySelector('input[name*="fechaFin"]');
            const categoria = card.querySelector('input[name*="categoria"]');
            const catVal = categoria ? categoria.value : '';

            state.criterios.push({
                nombre: nombreInput ? nombreInput.value : '',
                tipo: tipoSelect ? tipoSelect.value : '',
                pInicio: fechaInicio ? fechaInicio.value : '',
                pFin: fechaFin ? fechaFin.value : '',
                pCat: catVal
            });
        });
        return state;
    }

    function checkChanges() {
        if (!initialState) return;
        const currentState = getFormState();
        const submitBtn = document.getElementById('btn-submit');
        const hasChanges = JSON.stringify(initialState) !== JSON.stringify(currentState);
        if (hasChanges) {
            submitBtn.disabled = false;
            submitBtn.innerText = "Guardar Cambios";
        } else {
            submitBtn.disabled = true;
            submitBtn.innerText = "Sin cambios";
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        initialState = getFormState();
        document.getElementById('main-form').addEventListener('input', checkChanges);
        document.getElementById('main-form').addEventListener('change', checkChanges);
    });

    function agregarCriterio() {
        agregarCriterioUI(null);
        // IMPORTANTE: Reordenar al agregar para mantener coherencia
        reordenarIndices();
        checkChanges();
    }

    function agregarCriterioUI(data) {
        const container = document.getElementById('criterios-container');
        const wrapper = document.createElement('div');
        const idx = criterioIndex; // Usamos el contador global para IDs únicos de DOM

        wrapper.className = 'criterio-card';
        // Nota: Los IDs del DOM siguen siendo únicos e incrementales para que el JS no se rompa
        // Lo que cambiamos con reordenarIndices() es solo el atributo "name" que se envía al server.
        wrapper.id = `criterio-row-${idx}`;

        wrapper.innerHTML = `
            <button type="button" class="btn-delete-absolute" onclick="eliminarCriterio(${idx})" title="Eliminar">&times;</button>
            <div class="form-grid-2">
                <div>
                    <label class="content-title" style="font-size: 0.8rem;">Nombre del Criterio</label>
                    <input type="text" name="criteriosDePertenencias[${idx}].nombreCriterio" class="clean-input">
                </div>
                <div>
                    <label class="content-title" style="font-size: 0.8rem;">Tipo de Criterio</label>
                    <select name="criteriosDePertenencias[${idx}].tipoCriterio" class="clean-input" id="select-tipo-${idx}" onchange="actualizarParametros(this, ${idx})" style="background: white;">
                        <option value="">Seleccionar tipo...</option>
                        <option value="FECHA">Rango de Fechas</option>
                        <option value="CATEGORIA">Categoría Específica</option>
                    </select>
                </div>
            </div>
            <div id="parametros-${idx}"></div>
        `;

        container.appendChild(wrapper);
        criterioIndex++;
    }

    function eliminarCriterio(index) {
        const row = document.getElementById(`criterio-row-${index}`);
        if(row) row.remove();
        delete focusStates[index];

        // IMPORTANTE: Reordenar inmediatamente después de borrar
        // Así el índice 5 pasa a ser 4, y Spring no ve huecos.
        reordenarIndices();

        checkChanges();
    }

    // --- ACTUALIZAR PARÁMETROS ---
    function actualizarParametros(select, index, valores = {}) {
        const tipo = select.value;
        const paramsContainer = document.getElementById(`parametros-${index}`);
        paramsContainer.innerHTML = "";

        // Nota: Aquí al generar HTML dinámico usamos ${index} que es el ID único.
        // Después de insertarlo, llamamos a reordenarIndices() para arreglar los "name".

        if (tipo === "FECHA") {
            paramsContainer.innerHTML = `
                <div class="form-grid-2">
                    <div>
                        <label class="content-title" style="font-size: 0.8rem;">Desde</label>
                        <input type="date" name="criteriosDePertenencias[${index}].parametros[fechaInicio]" class="clean-input">
                    </div>
                    <div>
                        <label class="content-title" style="font-size: 0.8rem;">Hasta</label>
                        <input type="date" name="criteriosDePertenencias[${index}].parametros[fechaFin]" class="clean-input">
                    </div>
                </div>`;
        } else if (tipo === "CATEGORIA") {
            let opts = "";
            categoriasBackend.forEach(cat => {
                const nombre = cat.nombre || cat;
                opts += `<li class="autocomplete-item" onclick="selectDynamicCat(${index}, '${nombre}')">${nombre}</li>`;
            });
            opts += `<li id="no-results-${index}" class="autocomplete-item autocomplete-create-item" onclick="selectDynamicCat(${index}, document.getElementById('cat-input-${index}').value)"></li>`;

            paramsContainer.innerHTML = `
                <label class="content-title" style="font-size: 0.8rem;">Categoría Requerida</label>
                <div class="autocomplete-wrapper" id="cat-wrapper-${index}">
                    <input type="text" id="cat-input-${index}" name="criteriosDePertenencias[${index}].parametros[categoria]" class="clean-input" autocomplete="off"
                           placeholder="Escribe o selecciona..." oninput="filterDynamicCat(${index}); checkChanges();" onfocus="showDynamicCat(${index})" onkeydown="handleKeydown(${index}, event)">
                    <ul id="cat-list-${index}" class="autocomplete-list">${opts}</ul>
                </div>`;
            focusStates[index] = -1;
        }

        // Reordenamos nombres para asegurar que los nuevos inputs tengan el índice correcto
        reordenarIndices();
        checkChanges();
    }

    // --- LÓGICA AUTOCOMPLETE (Sin cambios) ---
    window.handleKeydown = function(index, e) {
        const list = document.getElementById(`cat-list-${index}`);
        if (!list || !list.classList.contains('active')) return;
        let items = Array.from(list.getElementsByTagName("li")).filter(i => i.style.display !== "none");
        if (e.key === "ArrowDown") { focusStates[index]++; addActive(items, index); }
        else if (e.key === "ArrowUp") { focusStates[index]--; addActive(items, index); }
        else if (e.key === "Enter") {
            e.preventDefault();
            if (focusStates[index] > -1 && items[focusStates[index]]) items[focusStates[index]].click();
            else if (items.length === 1 && items[0].id.startsWith("no-results")) items[0].click();
        } else if (e.key === "Escape") closeDynamicList(index);
    };

    function addActive(items, index) {
        if (!items.length) return;
        if (focusStates[index] >= items.length) focusStates[index] = 0;
        if (focusStates[index] < 0) focusStates[index] = items.length - 1;
        Array.from(items).forEach(i => i.classList.remove("autocomplete-active"));
        items[focusStates[index]].classList.add("autocomplete-active");
        items[focusStates[index]].scrollIntoView({ block: 'nearest' });
    }

    window.filterDynamicCat = function(index) {
        const input = document.getElementById(`cat-input-${index}`);
        const list = document.getElementById(`cat-list-${index}`);
        if(!input || !list) return;
        const filter = input.value.toLowerCase();
        let count = 0;

        Array.from(list.getElementsByTagName("li")).forEach(item => {
            if (item.id.startsWith("no-results")) return;
            if (item.innerText.toLowerCase().includes(filter)) { item.style.display = ""; count++; }
            else { item.style.display = "none"; }
        });

        const noRes = document.getElementById(`no-results-${index}`);
        if (count === 0 && filter) {
            noRes.style.display = "block";
            noRes.innerText = `Crear nueva: "${input.value}"`;
        } else { noRes.style.display = "none"; }
        list.classList.add('active');
        focusStates[index] = -1;
    };

    window.showDynamicCat = function(index) {
        const list = document.getElementById(`cat-list-${index}`);
        if(list) {
            window.filterDynamicCat(index);
            list.classList.add('active');
        }
    };

    window.selectDynamicCat = function(index, val) {
        document.getElementById(`cat-input-${index}`).value = val;
        closeDynamicList(index);
        checkChanges();
    };

    function closeDynamicList(index) {
        const list = document.getElementById(`cat-list-${index}`);
        if(list) list.classList.remove('active');
        focusStates[index] = -1;
    }

    document.addEventListener('click', function(e) {
        document.querySelectorAll('.autocomplete-wrapper').forEach(w => {
            if (!w.contains(e.target)) {
                const id = w.id.split('-')[2];
                closeDynamicList(id);
            }
        });
    });

</script>

</body>
</html>