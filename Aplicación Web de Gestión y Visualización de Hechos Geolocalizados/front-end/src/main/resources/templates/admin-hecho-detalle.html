<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin - Detalle del Hecho</title>
    <link rel="stylesheet" th:href="@{/css/global.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/hecho.css}">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
<div class="admin-layout">
    <aside class="sidebar">
        <a th:href="@{/}" class="logo">MetaMapa Admin</a>
        <nav class="sidebar__nav">
            <a th:href="@{/admin/dashboard}" class="sidebar__link">Dashboard</a>
            <a th:href="@{/admin/colecciones}" class="sidebar__link">Colecciones</a>
            <a th:href="@{/admin/revisiones}" class="sidebar__link sidebar__link--active">Revisiones</a>
        </nav>
        <a th:href="@{/auth/logout}" class="btn btn--secondary sidebar__logout">Cerrar Sesión</a>
    </aside>

    <div class="main-content">
        <div class="detail-container">

            <h1 class="page-title">Revisión de Hechos</h1>

            <div th:if="${mensaje}" class="api-success-alert mb-2">
                <span th:text="${mensaje}"></span>
            </div>

            <div class="stat-card">

                <div style="margin-bottom: 20px;">
                    <h1 class="section-title" th:text="${hecho.titulo}">Título</h1>
                </div>

                <div class="content-block" th:if="${not #lists.isEmpty(hecho.multimedia)}">
                    <h3 class="content-title">Imágenes</h3>

                    <div class="carousel-wrapper" id="carousel-container">
                        <button type="button" class="carousel-btn prev" id="btn-prev">&#10094;</button>

                        <div class="gallery-track" id="carousel-track">
                            <div th:each="imagen : ${hecho.multimedia}" class="gallery-item">
                                <img th:src="@{'/hechos/uploads/' + ${imagen}}" th:alt="'Evidencia'">
                            </div>
                        </div>

                        <button type="button" class="carousel-btn next" id="btn-next">&#10095;</button>
                    </div>
                </div>

                <div class="content-block">
                    <h3 class="content-title">Descripción</h3>
                    <p th:text="${hecho.descripcion}">
                        Descripción del hecho.
                    </p>
                </div>

                <div class="content-block">
                    <h3 class="content-title">Categoría</h3>
                    <p th:text="${hecho.categoria}">Categoría</p>
                </div>

                <div class="content-block">
                    <h3 class="content-title">Fecha del hecho</h3>
                    <p th:text="${#temporals.format(hecho.fechaHecho, 'dd/MM/yyyy HH:mm')}">
                        01/01/2024 12:00
                    </p>
                </div>

                <div class="content-block">
                    <h3 class="content-title">Fuentes</h3>
                    <div th:if="${not #lists.isEmpty(hecho.fuentes)}" style="display: flex; flex-wrap: wrap; gap: 8px;">
                      <span th:each="fuente : ${hecho.fuentes}"
                            th:text="${fuente.nombre}"
                            style="background-color: #f1f5f9; border: 1px solid #cbd5e1; padding: 4px 12px; border-radius: 16px; font-size: 0.85em; color: #475569; font-weight: 500;">
                          Fuente
                      </span>
                    </div>
                    <p th:if="${#lists.isEmpty(hecho.fuentes)}" style="color: #94a3b8; font-style: italic;">
                        No se han especificado fuentes.
                    </p>
                </div>

                <div class="content-block">
                    <h3 class="content-title">Detalles de Ubicación</h3>
                    <table class="detail-table">
                        <tbody>
                        <tr>
                            <th>Provincia</th>
                            <td th:text="${hecho.getUbicacionDTO != null ? hecho.getUbicacionDTO.provincia : '-'}">Provincia</td>
                        </tr>
                        <tr>
                            <th>Municipio</th>
                            <td th:text="${hecho.getUbicacionDTO != null ? hecho.getUbicacionDTO.municipio : '-'}">Municipio</td>
                        </tr>
                        <tr>
                            <th>Departamento</th>
                            <td th:text="${hecho.getUbicacionDTO != null ? hecho.getUbicacionDTO.departamento : '-'}">Departamento</td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="content-block" style="border-bottom: none;">
                    <h3 class="content-title">Ubicación en mapa</h3>
                    <div id="map-readonly" style="height: 400px; border-radius: 8px;"></div>
                </div>

                <div style="margin-top: 40px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <form th:action="@{/admin/revisiones/hechos/{id}/aprobar(id=${hecho.id})}" method="post">
                        <button class="btn btn--primary">Aprobar</button>
                    </form>
                    <form th:action="@{/admin/revisiones/hechos/{id}/editar(id=${hecho.id})}" method="get">
                        <button class="btn btn--secondary">Editar</button>
                    </form>
                    <form th:action="@{/admin/revisiones/hechos/{id}/rechazar(id=${hecho.id})}" method="post">
                        <button class="btn-reject" onclick="return confirm('¿Está seguro que quiere RECHAZAR este hecho?')">Rechazar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const latInicial = /*[[${hecho.ubicacionDTO?.latitud ?: -34.6037}]]*/ -34.6037;
        const lngInicial = /*[[${hecho.ubicacionDTO?.longitud ?: -58.3816}]]*/ -58.3816;

        const map = L.map('map-readonly').setView([latInicial, lngInicial], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
        L.marker([latInicial, lngInicial]).addTo(map).bindPopup("Ubicación del hecho").openPopup();
    });
</script>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {

        // --- INICIO LÓGICA CARRUSEL INFINITO ---
        const track = document.getElementById('carousel-track');
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');

        if (!track || track.children.length === 0) return;

        // Si solo hay 1 imagen, ocultamos flechas y no hacemos lógica
        const slidesOriginales = Array.from(track.children);
        if (slidesOriginales.length < 2) {
            if(btnPrev) btnPrev.style.display = 'none';
            if(btnNext) btnNext.style.display = 'none';
            return;
        }

        // 1. Clonar primera y última diapositiva para el efecto infinito
        const firstClone = slidesOriginales[0].cloneNode(true);
        const lastClone = slidesOriginales[slidesOriginales.length - 1].cloneNode(true);

        // Identificadores para depuración (opcional)
        firstClone.id = 'first-clone';
        lastClone.id = 'last-clone';

        // 2. Insertar clones en el DOM
        track.append(firstClone);
        track.prepend(lastClone);

        const slides = track.children; // Ahora incluye clones
        let counter = 1; // Empezamos en 1 porque el 0 es el lastClone
        let size = slidesOriginales[0].clientWidth; // Ancho inicial

        // Posicionar en la primera imagen real (saltando el clon inicial)
        track.style.transform = 'translateX(' + (-size * counter) + 'px)';

        // Actualizar tamaño si se redimensiona la ventana
        window.addEventListener('resize', () => {
            size = track.clientWidth; // El wrapper controla el ancho visible
            track.style.transition = "none"; // Sin animación al redimensionar
            track.style.transform = 'translateX(' + (-size * counter) + 'px)';
        });

        // --- MOVIMIENTO ---

        const moveToNext = () => {
            if (counter >= slides.length - 1) return;
            track.style.transition = "transform 0.4s ease-in-out";
            counter++;
            track.style.transform = 'translateX(' + (-size * counter) + 'px)';
        };

        const moveToPrev = () => {
            if (counter <= 0) return;
            track.style.transition = "transform 0.4s ease-in-out";
            counter--;
            track.style.transform = 'translateX(' + (-size * counter) + 'px)';
        };

        // Listeners Botones
        if(btnNext) btnNext.addEventListener('click', moveToNext);
        if(btnPrev) btnPrev.addEventListener('click', moveToPrev);

        // --- EL SALTO MÁGICO (LOOP) ---
        // Se ejecuta cuando termina la transición
        track.addEventListener('transitionend', () => {
            // Si estamos en el clon de la primera (al final)
            if (slides[counter].id === 'first-clone') {
                track.style.transition = "none"; // Quitamos animación
                counter = 1; // Saltamos a la imagen 1 real
                track.style.transform = 'translateX(' + (-size * counter) + 'px)';
            }
            // Si estamos en el clon de la última (al principio)
            if (slides[counter].id === 'last-clone') {
                track.style.transition = "none"; // Quitamos animación
                counter = slides.length - 2; // Saltamos a la última imagen real
                track.style.transform = 'translateX(' + (-size * counter) + 'px)';
            }
        });
    });
</script>
</body>
</html>